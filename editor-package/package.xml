<project name="package" default="all" basedir="."
         xmlns:rsel="antlib:org.apache.tools.ant.types.resources.selectors">

    <target name="all">
        <delete dir="target/package" />

        <!-- Remove current module classpath -->
        <restrict id="test">
            <path path="${runtime_classpath}"/>
            <rsel:not>
                <rsel:name name="**/classes"/>
            </rsel:not>
        </restrict>
        <pathconvert property="t" refid="test"/>

        <!-- Copy to lib dir -->
        <mkdir dir="target/package"/>
        <mkdir dir="target/package/lib"/>
        <copy todir="target/package/lib" flatten="true">
            <path path="${t}"/>
            <chainedmapper>
                <flattenmapper/>
            </chainedmapper>
        </copy>

        <available file="target/share" property="share.present"/>
        <antcall target="checkout-share" />

        <antcall target="build-mac-app" />
        <antcall target="build-zip-app" />
    </target>

    <target name="checkout-share"
            depends="checkout-share-checkout,checkout-share-update"/>

    <target name="checkout-share-checkout" unless="share.present">
        <mkdir dir="target/share" />
        <exec dir="target/share" command="svn checkout http://svn.textmate.org/trunk/Themes" />
        <exec dir="target/share" command="svn checkout http://svn.textmate.org/trunk/Support" />
    </target>

    <target name="checkout-share-update" if="share.present">
        <exec command="svn update target/share/Themes" />
        <exec command="svn update target/share/Support" />
    </target>

    <target name="build-mac-app">
        <mkdir dir="target/package/mac" />


        <path id="lib-classpath">
            <fileset dir="target/package/lib" includes="*.jar" />
        </path>

        <pathconvert property="cp" refid="lib-classpath" pathsep=":">
            <mapper>
                <chainedmapper>
                <flattenmapper/>
                <regexpmapper from="^(.*)\.jar$$" to="$JAVAROOT/\1.jar" />
                </chainedmapper>
            </mapper>
        </pathconvert>


        <copy todir="target/package/mac">
            <fileset dir="mac" />
             <filterset>
                <filter token="CLASSPATH" value="${cp}"/>
            </filterset>
        </copy>

        <copy todir="target/package/mac/JSourcePad.app/Contents/MacOS"
              file="/System/Library/Frameworks/JavaVM.framework/Versions/Current/Resources/MacOS/JavaApplicationStub" />

        <exec command="chmod +x target/package/mac/JSourcePad.app/Contents/MacOS/JavaApplicationStub" />

        <copy todir="target/package/mac/JSourcePad.app/Contents/Resources/Java">
            <fileset dir="target/package/lib" />
        </copy>

        <copy todir="target/package/mac/JSourcePad.app/Contents/Resources/Shared">
            <fileset dir="target/share">
                <exclude name="**/LaTeXUtils.rb" />
                <exclude name="**/.svn" />
            </fileset>
        </copy>

        <exec command="/Developer/Tools/SetFile -a B target/package/mac/JSourcePad.app" />
    </target>

    <target name="build-zip-app">
        <mkdir dir="target/package/zip-app" />

        <path id="lib-classpath">
            <fileset dir="target/package/lib" includes="*.jar" />
        </path>

        <pathconvert property="cp" refid="lib-classpath" pathsep=";">
            <mapper>
                <chainedmapper>
                <flattenmapper/>
                <regexpmapper from="^(.*)\.jar$$" to="%~dp0lib/\1.jar" />
                </chainedmapper>
            </mapper>
        </pathconvert>

        <pathconvert property="unix-cp" refid="lib-classpath" pathsep=":">
            <mapper>
                <chainedmapper>
                <flattenmapper/>
                <regexpmapper from="^(.*)\.jar$$" to="lib/\1.jar" />
                </chainedmapper>
            </mapper>
        </pathconvert>

        <copy todir="target/package/zip-app">
             <fileset dir="zip/contents" />
             <filterset>
                <filter token="CLASSPATH" value="${cp}"/>
                <filter token="UNIXCLASSPATH" value="${unix-cp}"/>
            </filterset>
        </copy>

        <copy todir="target/package/zip-app/lib">
            <fileset dir="target/package/lib" />
        </copy>

        <property name="launch4j.dir" location="/Users/magnus/Desktop/launch4j" />
        <taskdef name="launch4j"
            classname="net.sf.launch4j.ant.Launch4jTask"
            classpath="${launch4j.dir}/launch4j.jar:${launch4j.dir}/lib/xstream.jar" />
        <launch4j configFile="zip/launch4j.xml" outfile="target/package/zip-app/jsourcepad.exe" />

        <zip file="target/package/jsourcepad.zip">
            <zipfileset dir="target/package/zip-app" prefix="jsourcepad" />
            <zipfileset dir="target/share" prefix="jsourcepad/Shared">
                <exclude name="**/LaTeXUtils.rb" />
                <exclude name="**/.svn" />
            </zipfileset>
        </zip>
    </target>

</project>
